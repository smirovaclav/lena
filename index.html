<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generátor faktur (GitHub Pages)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#111; --muted:#6b7280; --border:#e5e7eb; --accent:#0b5cab; --bg:#f7fafc;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:20px;max-width:1100px;margin:24px auto;padding:0 16px}
    .panel{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
    .panel h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:14px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    .panel .body{padding:14px 16px}
    label{display:block;font-size:12px;color:var(--muted);margin:.5rem 0 .25rem}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#111}
    .items-table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .items-table th{font-size:12px;color:var(--muted);text-align:left;padding:6px 8px}
    .items-table td{background:#fff;border:1px solid var(--border);padding:8px;border-radius:10px}

    /* ===== INVOICE SHEET ===== */
    .sheet{max-width:800px;margin:0 auto;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);overflow:hidden}
    header{padding:24px 28px;border-bottom:1px solid var(--border);background:#fff}
    .head-grid{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start}
    .logo-slot{width:160px;height:80px;border:2px dashed #cbd5e1;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .logo-slot img{max-width:100%;max-height:100%;object-fit:contain}
    .brand h1{margin:8px 0 0 0;font-size:22px;letter-spacing:.02em}
    .badge{display:inline-block;background:rgba(11,92,171,.08);color:var(--accent);padding:6px 10px;border-radius:8px;font-weight:600;font-size:12px}
    .meta{margin-top:10px;display:flex;flex-wrap:wrap;gap:14px}
    .meta div{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:22px 28px}
    .card{border:1px solid var(--border);border-radius:10px;padding:16px;background:#fff}
    .card h3{margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    .card p{margin:0;font-size:14px}

    .items{padding:0 28px 8px 28px;display:grid;gap:8px}
    .row-item{border:1px solid var(--border);border-radius:10px;padding:12px 14px;display:grid;grid-template-columns:1fr 120px 140px 160px;gap:12px;align-items:center}
    .row-item .note{color:var(--muted);font-size:12px}
    .total-box{margin:8px 28px 12px 28px;display:flex;justify-content:flex-end}
    .total-card{min-width:260px;border:2px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff}
    .total-card .label{font-size:12px;color:var(--muted)}
    .total-card .value{font-size:18px;font-weight:700}

    footer{padding:16px 28px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:#fff}
    .qrimg{margin-top:6px;max-width:160px;display:inline-block}

    @media print{
      body{background:#fff}
      .wrap{display:block}
      .panel{display:none}
      .sheet{margin:0;border:none;box-shadow:none;border-radius:0;width:100%;max-width:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ===== LEFT CONTROL PANEL ===== -->
    <div class="panel">
      <h2>Vstupní údaje</h2>
      <div class="body">
        <label>Logo (PNG/JPG)</label>
        <input type="file" id="logoInput" accept="image/*" />
        <div class="row">
          <div>
            <label>Číslo faktury</label>
            <input id="invNumber" value="2025-001" />
          </div>
          <div>
            <label>Neplátce DPH</label>
            <select id="vatBadge">
              <option value="true" selected>Ano</option>
              <option value="false">Ne</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Datum vystavení</label>
            <input id="issueDate" type="date" />
          </div>
          <div>
            <label>Datum splatnosti (text)</label>
            <input id="dueDate" type="date" />
          </div>
        </div>

        <h3 style="margin-top:16px">Vystavitel</h3>
        <label>Název / jméno</label>
        <input id="supName" value="Jan Dvořák" />
        <label>Adresa</label>
        <textarea id="supAddr" rows="2">Křižíkova 12, 186 00 Praha 8</textarea>
        <div class="row">
          <div>
            <label>IČ</label>
            <input id="supIC" value="12345678" />
          </div>
          <div>
            <label>DIČ (volitelné)</label>
            <input id="supDIC" placeholder="CZ12345678" />
          </div>
        </div>

        <h3 style="margin-top:16px">Příjemce</h3>
        <label>Název / jméno</label>
        <input id="cliName" value="Alfa Beta, s.r.o." />
        <label>Adresa</label>
        <textarea id="cliAddr" rows="2">Jungmannova 26/15, 110 00 Praha 1</textarea>
        <div class="row">
          <div>
            <label>IČ</label>
            <input id="cliIC" value="87654321" />
          </div>
          <div>
            <label>DIČ (volitelné)</label>
            <input id="cliDIC" placeholder="CZ87654321" />
          </div>
        </div>

        <h3 style="margin-top:16px">Položky</h3>
        <table class="items-table" id="itemsTable">
          <thead>
            <tr>
              <th>Popis</th>
              <th>Počet ks</th>
              <th>Cena/ks (Kč)</th>
              <th>Mezisoučet</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="addItem">+ Přidat položku</button>
          <button class="btn secondary" id="recalc">Přepočítat</button>
        </div>

        <h3 style="margin-top:16px">Platba</h3>
        <div class="row">
          <div>
            <label>Předčíslí</label>
            <input id="accPrefix" placeholder="19" />
          </div>
          <div>
            <label>Číslo účtu</label>
            <input id="accNumber" value="222785210" />
          </div>
          <div>
            <label>Kód banky</label>
            <input id="bankCode" value="0600" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Variabilní symbol</label>
            <input id="vs" value="2025001" />
          </div>
          <div>
            <label>Měna</label>
            <input id="currency" value="CZK" />
          </div>
        </div>
        <label>Zpráva pro příjemce</label>
        <input id="payMsg" value="Faktura 2025-001" />

        <h3 style="margin-top:16px">Kontakt ve footeru</h3>
        <div class="row">
          <div>
            <label>Telefon</label>
            <input id="phone" value="+420 777 123 456" />
          </div>
          <div>
            <label>Email</label>
            <input id="email" value="jan.dvorak@example.com" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:16px">
          <button class="btn" id="makePdf">Vygenerovat PDF</button>
          <button class="btn secondary" id="updatePreview">Aktualizovat náhled</button>
        </div>
      </div>
    </div>

    <!-- ===== RIGHT PREVIEW (PRINT AREA) ===== -->
    <div class="panel">
      <h2>Náhled faktury</h2>
      <div class="body">
        <div id="invoice" class="sheet">
          <header>
            <div class="head-grid">
              <div>
                <div class="logo-slot" id="logoSlot"><span>Logo</span></div>
                <div class="brand">
                  <h1 id="invTitle">Faktura č. 2025-001</h1>
                  <span id="vatBadgeView" class="badge">Neplátce DPH</span>
                </div>
                <div class="meta" id="metaDates"></div>
              </div>
              <div id="qrWrap" style="text-align:right">
                <img id="qrImg" class="qrimg" alt="QR Platba" />
              </div>
            </div>
          </header>

          <section class="grid">
            <div class="card">
              <h3>Vystavitel (dodavatel)</h3>
              <p id="supBlock"></p>
            </div>
            <div class="card">
              <h3>Příjemce (odběratel)</h3>
              <p id="cliBlock"></p>
            </div>
          </section>

          <section class="items" id="itemsPreview"></section>

          <div class="total-box">
            <div class="total-card">
              <div class="label">Cena celkem k úhradě</div>
              <div class="value" id="grandTotal">0 Kč</div>
            </div>
          </div>

          <section class="grid" style="padding-top:0;align-items:center">
            <div class="card">
              <h3>Platební údaje</h3>
              <p id="payBlock"></p>
            </div>
          </section>

          <footer>
            <div id="leftFoot">Telefon: +420 777 123 456</div>
            <div id="rightFoot">Email: jan.dvorak@example.com</div>
          </footer>
        </div>
      </div>
    </div>
  </div>

  <!-- html2pdf for client-side PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
    // ===== Helpers =====
    const fmtCZK = (num)=> new Intl.NumberFormat('cs-CZ', {style:'currency', currency:'CZK'}).format(num);

    // formátování data vystavení (DD.MM.YYYY) - bezpečně pro YYYY-MM-DD nebo Date
    const fmtDateCZ = (isoOrDate)=>{
      if(!isoOrDate) return '';
      if(isoOrDate instanceof Date){
        const d = isoOrDate;
        return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      }
      const m = String(isoOrDate).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m){
        return `${m[3]}.${m[2]}.${m[1]}`;
      }
      return String(isoOrDate);
    };

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // ===== Items dynamic table =====
    const items = [
      { desc: 'Datová analýza – konzultace', qty: 4, unit: 850 },
      { desc: 'Zpracování reportu', qty: 2, unit: 925 }
    ];

    function renderItemsEditor(){
      const body = document.getElementById('itemsBody');
      body.innerHTML = '';
      items.forEach((it, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${it.desc}" data-i="${idx}" data-k="desc"/></td>
          <td style="width:110px"><input type="number" min="0" step="1" value="${it.qty}" data-i="${idx}" data-k="qty"/></td>
          <td style="width:140px"><input type="number" min="0" step="0.01" value="${it.unit}" data-i="${idx}" data-k="unit"/></td>
          <td style="width:160px"><input value="${fmtCZK(it.qty*it.unit)}" disabled/></td>
        `;
        body.appendChild(tr);
      });
    }

    function addItem(){ items.push({desc:'Nová položka', qty:1, unit:1000}); renderItemsEditor(); updateAll(); }

    function hookItemInputs(){
      document.getElementById('itemsBody').addEventListener('input', (e)=>{
        const i = +e.target.dataset.i; const k = e.target.dataset.k;
        if(k){
          let v = e.target.value;
          if(k!=='desc') v = parseFloat(v || 0);
          items[i][k] = v;
          updateAll();
        }
      });
    }

    function calcTotal(){ return items.reduce((s,it)=> s + (Number(it.qty)||0)*(Number(it.unit)||0), 0); }

    function renderItemsPreview(){
      const wrap = document.getElementById('itemsPreview');
      wrap.innerHTML = '';
      items.forEach(it=>{
        const row = document.createElement('div');
        row.className = 'row-item';
        row.innerHTML = `
          <div>
            <div class="note">Položka</div>
            <strong>${it.desc || ''}</strong>
          </div>
          <div style="text-align:right">
            <div class="note">Počet ks</div>
            <strong>${Number(it.qty)||0}</strong>
          </div>
          <div style="text-align:right">
            <div class="note">Cena/ks</div>
            <strong>${fmtCZK(Number(it.unit)||0)}</strong>
          </div>
          <div style="text-align:right">
            <div class="note">Mezisoučet</div>
            <strong>${fmtCZK((Number(it.qty)||0)*(Number(it.unit)||0))}</strong>
          </div>`;
        wrap.appendChild(row);
      });
    }

  // ===== QR generator (Paylibo) =====
  async function buildQR(total){
    const accP = (document.getElementById('accPrefix').value || '').trim();
    const accN = (document.getElementById('accNumber').value || '').trim();
    const bank = (document.getElementById('bankCode').value || '').trim();
    const currency = (document.getElementById('currency').value || '').trim() || 'CZK';
    const vs = (document.getElementById('vs').value || '').trim();
    const msg = (document.getElementById('payMsg').value || '').trim();
  
    // display account (prefix only if existuje)
    const accDisplay = accP ? `${accP}-${accN}/${bank}` : `${accN}/${bank}`;
    document.getElementById('payBlock').innerHTML = `
      Bankovní účet: <strong>${accDisplay}</strong><br>
      Variabilní symbol: <strong>${vs}</strong><br>
      Způsob úhrady: bankovní převod`;
  
    const params = new URLSearchParams({
      accountNumber: accN,
      bankCode: bank,
      amount: total.toFixed(2),
      currency,
      vs,
      message: msg
    });
    // přidat accountPrefix jen pokud existuje (správně uzavřeno)
    if(accP) params.append('accountPrefix', accP);
  
    const url = `https://api.paylibo.com/paylibo/generator/czech/image?${params.toString()}`;
  
    try{
      const res = await fetch(url, {mode:'cors'});
      const blob = await res.blob();
      const reader = new FileReader();
      const p = new Promise(ok=>{ reader.onload = ()=> ok(reader.result); });
      reader.readAsDataURL(blob);
      const dataUrl = await p;
      document.getElementById('qrImg').src = dataUrl;
    }catch(err){
      // fallback: direct URL (může mít CORS)
      document.getElementById('qrImg').src = url;
    }
  }
  
  
  // ===== Main render =====
  function updateAll(){
    // Header title + badge
    const invNo = (document.getElementById('invNumber').value || '').trim();
    document.getElementById('invTitle').textContent = `Faktura č. ${invNo || '---'}`;
    const showBadge = document.getElementById('vatBadge').value === 'true';
    document.getElementById('vatBadgeView').style.display = showBadge? 'inline-block':'none';
  
    // Dates: issueDate is ISO (date input). dueDate may be date or free text.
    const issue = document.getElementById('issueDate').value || todayISO();
    const dueRaw = (document.getElementById('dueDate').value || '').trim();
  
    // Pokud dueRaw vypadá jako ISO YYYY-MM-DD (třeba kdyby máš type="date"), převeď hezky,
    // jinak zobraz přesně ten text (uživatel chce volný string).
    let dueDisplay;
    if(/^\d{4}-\d{2}-\d{2}$/.test(dueRaw)){
      dueDisplay = fmtDateCZ(dueRaw);
    } else {
      dueDisplay = dueRaw || '---';
    }
  
    const meta = document.getElementById('metaDates');
    meta.innerHTML = `
      <div>Datum vystavení: <strong>${fmtDateCZ(issue)}</strong></div>
      <div>Datum splatnosti: <strong>${dueDisplay}</strong></div>
    `;
  
    // Parties
    const sup = {
      name: document.getElementById('supName').value,
      addr: document.getElementById('supAddr').value,
      ic: document.getElementById('supIC').value,
      dic: document.getElementById('supDIC').value
    };
    const cli = {
      name: document.getElementById('cliName').value,
      addr: document.getElementById('cliAddr').value,
      ic: document.getElementById('cliIC').value,
      dic: document.getElementById('cliDIC').value
    };
    document.getElementById('supBlock').innerHTML = `
      <strong>${sup.name}</strong><br>${sup.addr.replaceAll('\n','<br>')}<br>
      IČ: ${sup.ic}${sup.dic? `<br>DIČ: ${sup.dic}`:''}`;
    document.getElementById('cliBlock').innerHTML = `
      <strong>${cli.name}</strong><br>${cli.addr.replaceAll('\n','<br>')}<br>
      IČ: ${cli.ic}${cli.dic? `<br>DIČ: ${cli.dic}`:''}`;
  
    // Items + total
    renderItemsPreview();
    const total = calcTotal();
    document.getElementById('grandTotal').textContent = fmtCZK(total);
  
    // Payment block (zobrazit prefix jen pokud existuje)
    const accP = (document.getElementById('accPrefix').value || '').trim();
    const accN = (document.getElementById('accNumber').value || '').trim();
    const bank = (document.getElementById('bankCode').value || '').trim();
    const vs = (document.getElementById('vs').value || '').trim();
    const accBlock = accP ? `${accP}-${accN}/${bank}` : `${accN}/${bank}`;
    document.getElementById('payBlock').innerHTML = `
      Bankovní účet: <strong>${accBlock}</strong><br>
      Variabilní symbol: <strong>${vs}</strong><br>
      Způsob úhrady: bankovní převod`;
  
    // Footer
    document.getElementById('leftFoot').textContent = `Telefon: ${document.getElementById('phone').value}`;
    document.getElementById('rightFoot').textContent = `Email: ${document.getElementById('email').value}`;
  
    // QR code
    buildQR(total);
  }
  
  
  // ===== Init =====
  function init(){
    document.getElementById('issueDate').value = todayISO();
    document.getElementById('dueDate').value = todayISO();
  
    renderItemsEditor();
    hookItemInputs();
    updateAll();
  }
    init();
  </script>
</body>
</html>
