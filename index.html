<script>
  // ===== Helpers =====
  const fmtCZK = (num)=> new Intl.NumberFormat('cs-CZ', {style:'currency', currency:'CZK'}).format(num);

  // formátujeme datum vystavení (DD.MM.YYYY)
  const fmtDateCZ = (isoOrDate)=>{
    if(!isoOrDate) return '';
    if(isoOrDate instanceof Date){
      const d = isoOrDate;
      return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
    }
    // očekáváme YYYY-MM-DD
    const m = String(isoOrDate).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(m){
      return `${m[3]}.${m[2]}.${m[1]}`;
    }
    // fallback: vrátit string tak jak je
    return String(isoOrDate);
  };

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  // ===== Items dynamic table =====
  const items = [
    { desc: 'Datová analýza – konzultace', qty: 4, unit: 850 },
    { desc: 'Zpracování reportu', qty: 2, unit: 925 }
  ];

  function renderItemsEditor(){
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';
    items.forEach((it, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${it.desc}" data-i="${idx}" data-k="desc"/></td>
        <td style="width:110px"><input type="number" min="0" step="1" value="${it.qty}" data-i="${idx}" data-k="qty"/></td>
        <td style="width:140px"><input type="number" min="0" step="0.01" value="${it.unit}" data-i="${idx}" data-k="unit"/></td>
        <td style="width:160px"><input value="${fmtCZK(it.qty*it.unit)}" disabled/></td>
      `;
      body.appendChild(tr);
    });
  }

  function addItem(){ items.push({desc:'Nová položka', qty:1, unit:1000}); renderItemsEditor(); updateAll(); }

  function hookItemInputs(){
    document.getElementById('itemsBody').addEventListener('input', (e)=>{
      const i = +e.target.dataset.i; const k = e.target.dataset.k;
      if(k){
        let v = e.target.value;
        if(k!=='desc') v = parseFloat(v || 0);
        items[i][k] = v;
        updateAll();
      }
    });
  }

  function calcTotal(){ return items.reduce((s,it)=> s + (Number(it.qty)||0)*(Number(it.unit)||0), 0); }

  function renderItemsPreview(){
    const wrap = document.getElementById('itemsPreview');
    wrap.innerHTML = '';
    items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'row-item';
      row.innerHTML = `
        <div>
          <div class="note">Položka</div>
          <strong>${it.desc || ''}</strong>
        </div>
        <div style="text-align:right">
          <div class="note">Počet ks</div>
          <strong>${Number(it.qty)||0}</strong>
        </div>
        <div style="text-align:right">
          <div class="note">Cena/ks</div>
          <strong>${fmtCZK(Number(it.unit)||0)}</strong>
        </div>
        <div style="text-align:right">
          <div class="note">Mezisoučet</div>
          <strong>${fmtCZK((Number(it.qty)||0)*(Number(it.unit)||0))}</strong>
        </div>`;
      wrap.appendChild(row);
    });
  }

  // ===== QR generator (Paylibo) =====
  async function buildQR(total){
    const acc = document.getElementById('accNumber').value.trim();
    const bank = document.getElementById('bankCode').value.trim();
    const currency = document.getElementById('currency').value.trim() || 'CZK';
    const vs = document.getElementById('vs').value.trim();
    const msg = document.getElementById('payMsg').value.trim();

    const params = new URLSearchParams({
      accountNumber: acc,
      bankCode: bank,
      amount: total.toFixed(2),
      currency,
      vs,
      message: msg
    });
    const url = `https://api.paylibo.com/paylibo/generator/czech/image?${params.toString()}`;

    try{
      const res = await fetch(url, {mode:'cors'});
      const blob = await res.blob();
      const reader = new FileReader();
      const p = new Promise(ok=>{ reader.onload = ()=> ok(reader.result); });
      reader.readAsDataURL(blob);
      const dataUrl = await p;
      document.getElementById('qrImg').src = dataUrl;
    }catch(err){
      document.getElementById('qrImg').src = url;
    }
  }

  // ===== Main render =====
  function updateAll(){
    // Header title + badge
    const invNo = document.getElementById('invNumber').value.trim();
    document.getElementById('invTitle').textContent = `Faktura č. ${invNo || '---'}`;
    const showBadge = document.getElementById('vatBadge').value === 'true';
    document.getElementById('vatBadgeView').style.display = showBadge? 'inline-block':'none';

    // Dates
    const issue = document.getElementById('issueDate').value || todayISO();
    // dueDate je prostý text (string) zadávaný uživatelem
    const dueText = document.getElementById('dueDate').value || '';

    const meta = document.getElementById('metaDates');
    meta.innerHTML = `
      <div>Datum vystavení: <strong>${fmtDateCZ(issue)}</strong></div>
      <div>Datum splatnosti: <strong>${dueText ? dueText : '---'}</strong></div>
    `;

    // Parties
    const sup = {
      name: document.getElementById('supName').value,
      addr: document.getElementById('supAddr').value,
      ic: document.getElementById('supIC').value,
      dic: document.getElementById('supDIC').value
    };
    const cli = {
      name: document.getElementById('cliName').value,
      addr: document.getElementById('cliAddr').value,
      ic: document.getElementById('cliIC').value,
      dic: document.getElementById('cliDIC').value
    };
    document.getElementById('supBlock').innerHTML = `
      <strong>${sup.name}</strong><br>${sup.addr.replaceAll('\n','<br>')}<br>
      IČ: ${sup.ic}${sup.dic? `<br>DIČ: ${sup.dic}`:''}`;
    document.getElementById('cliBlock').innerHTML = `
      <strong>${cli.name}</strong><br>${cli.addr.replaceAll('\n','<br>')}<br>
      IČ: ${cli.ic}${cli.dic? `<br>DIČ: ${cli.dic}`:''}`;

    // Items + total
    renderItemsPreview();
    const total = calcTotal();
    document.getElementById('grandTotal').textContent = fmtCZK(total);

    // Payment block
    const acc = document.getElementById('accNumber').value.trim();
    const bank = document.getElementById('bankCode').value.trim();
    const vs = document.getElementById('vs').value.trim();
    const currency = document.getElementById('currency').value.trim()||'CZK';
    document.getElementById('payBlock').innerHTML = `
      Bankovní účet: <strong>${acc}/${bank}</strong><br>
      Variabilní symbol: <strong>${vs}</strong><br>
      Způsob úhrady: bankovní převod`;

    // Footer
    document.getElementById('leftFoot').textContent = `Telefon: ${document.getElementById('phone').value}`;
    document.getElementById('rightFoot').textContent = `Email: ${document.getElementById('email').value}`;

    // QR
    buildQR(total);
  }

  // ===== Logo upload =====
  document.getElementById('logoInput').addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    const slot = document.getElementById('logoSlot');
    if(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        slot.innerHTML = `<img src="${reader.result}" alt="logo"/>`;
      }
      reader.readAsDataURL(file);
    } else {
      slot.innerHTML = '<span>Logo</span>';
    }
  });

  // ===== Buttons =====
  document.getElementById('addItem').addEventListener('click', (e)=>{ e.preventDefault(); addItem(); });
  document.getElementById('recalc').addEventListener('click', (e)=>{ e.preventDefault(); updateAll(); });
  document.getElementById('updatePreview').addEventListener('click', (e)=>{ e.preventDefault(); updateAll(); });

  document.getElementById('makePdf').addEventListener('click', async (e)=>{
    e.preventDefault();
    updateAll();
    const element = document.getElementById('invoice');
    const fileName = `faktura_${document.getElementById('invNumber').value || 'dokument'}.pdf`;
    const opt = {
      margin:       [10, 10],
      filename:     fileName,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    await html2pdf().set(opt).from(element).save();
  });

  // ===== Init =====
  function init(){
    // pouze issue date se nastaví na dnes
    document.getElementById('issueDate').value = todayISO();

    renderItemsEditor();
    hookItemInputs();
    updateAll();
  }
  init();
</script>
